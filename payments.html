<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>RentPro â€” Payments</title>
  
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    :root { --rp-primary: #1d4ed8; --rp-dark: #111827; --rp-light: #f8fafc; --sidebar-width: 260px; }
    body { background: var(--rp-light); font-family: 'Inter', system-ui, sans-serif; font-size: 0.9rem; color: #334155; }

    /* Sidebar */
    .sidebar { width: var(--sidebar-width); min-height: 100vh; background: var(--rp-dark); color: #fff; position: fixed; top: 0; left: 0; display: flex; flex-direction: column; z-index: 1000; }
    .sidebar-header { padding: 20px; border-bottom: 1px solid rgba(255,255,255,0.05); }
    .nav-link { color: #94a3b8; padding: 14px 24px; display: flex; align-items: center; gap: 12px; text-decoration: none; transition: 0.2s; font-weight: 500; }
    .nav-link:hover { background: rgba(255,255,255,0.05); color: #fff; padding-left: 28px; }
    .nav-link.active { background: linear-gradient(90deg, rgba(37, 99, 235, 0.15) 0%, transparent 100%); border-left: 4px solid #3b82f6; color: white; }
    
    /* Content */
    .content { margin-left: var(--sidebar-width); padding: 40px; }
    
    /* Card Style */
    .card-table { background: #fff; border-radius: 12px; border: 1px solid #e2e8f0; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); overflow: hidden; }
    
    /* Table Styling */
    .table thead th { background: #f8fafc; font-weight: 700; text-transform: uppercase; font-size: 0.75rem; color: #64748b; padding: 16px; border-bottom: 1px solid #e2e8f0; letter-spacing: 0.5px; }
    .table tbody td { padding: 16px; border-bottom: 1px solid #f1f5f9; vertical-align: middle; }
    .table tr:last-child td { border-bottom: none; }
    
    /* Badges */
    .badge-ref { background: #f1f5f9; color: #475569; padding: 4px 8px; border-radius: 4px; font-family: monospace; font-size: 0.8rem; border: 1px solid #e2e8f0; }
    .badge-status { background: #dcfce7; color: #166534; padding: 4px 10px; border-radius: 20px; font-weight: 600; font-size: 0.7rem; text-transform: uppercase; }

    @media (max-width: 768px) { .content { margin-left: 0; padding: 20px; } .sidebar { display: none; } }
  </style>
</head>
<body>

  <div class="sidebar">
    <div class="sidebar-header"><h5 class="m-0 fw-bold"><i class="fa-solid fa-building me-2"></i> RentPro</h5></div>
    <nav class="mt-2">
        <a href="dashboard.html" class="nav-link"><i class="fa-solid fa-chart-pie"></i> Dashboard</a>
        <a href="tenants.html" class="nav-link"><i class="fa-solid fa-users"></i> Tenants</a>
        <a href="payments.html" class="nav-link active"><i class="fa-solid fa-money-bill-wave"></i> Payments</a>
        <a href="pay.html" class="nav-link"><i class="fa-solid fa-credit-card"></i> Pay Rent</a>
        <a href="expenses.html" class="nav-link"><i class="fa-solid fa-receipt"></i> Expenses</a>
        <a href="reports.html" class="nav-link"><i class="fa-solid fa-chart-column"></i> Reports</a>
        <div class="mt-auto border-top border-secondary pt-2">
            <a href="#" class="nav-link text-danger" id="logoutBtn"><i class="fa-solid fa-right-from-bracket"></i> Logout</a>
        </div>
    </nav>
  </div>

  <main class="content">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <div>
        <h2 class="fw-bold mb-1 text-dark">Payment History</h2>
        <p class="text-muted small m-0">Real-time log of incoming transactions.</p>
      </div>
      <button onclick="loadPayments()" class="btn btn-outline-primary btn-sm">
        <i class="fa-solid fa-rotate me-2"></i> Refresh List
      </button>
    </div>

    <div class="card-table">
      <div class="table-responsive">
        <table class="table table-hover mb-0">
          <thead>
            <tr>
              <th>Date</th>
              <th>Reference</th>
              <th>Payer Name</th>
              <th>Match Status</th>
              <th class="text-end">Amount</th>
            </tr>
          </thead>
          <tbody id="paymentTableBody">
             <tr>
               <td colspan="5" class="text-center p-5 text-muted">
                 <i class="fa-solid fa-circle-notch fa-spin fs-4 mb-2"></i><br>Syncing transactions...
               </td>
             </tr>
          </tbody>
        </table>
      </div>
    </div>
  </main>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBwJEOW3jVBHLizWiJjT4a_Tay-2yUCZwk",
        authDomain: "rentpro-saas.firebaseapp.com",
        projectId: "rentpro-saas",
        storageBucket: "rentpro-saas.firebasestorage.app",
        messagingSenderId: "120985965272",
        appId: "1:120985965272:web:c86eae74aa75460b17fdad",
        measurementId: "G-LJRKHT6ZTD"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    let currentUserUID = null;

    // Use your specific Script URL
    const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbzsWx1USYqSBOGLttP8GibfJdSfRLu9bDGSGiuOGj1TuI88gH7nTXJTZqy0Iwd3oMg2_w/exec"; 

    onAuthStateChanged(auth, (user) => {
        if (user) {
            currentUserUID = user.uid;
            loadPayments();
        } else {
            window.location.href = "index.html";
        }
    });

    const money = (amount) => {
        return new Intl.NumberFormat('en-KE', { 
            style: 'currency', currency: 'KES', minimumFractionDigits: 0 
        }).format(amount).replace('KES', '').trim();
    };

    // --- HELPER: Normalize Object Keys ---
    // Converts "M-Pesa Name" -> "mpesaname", "Ref Code" -> "refcode" for easy matching
    function normalizeData(item) {
        const newItem = {};
        Object.keys(item).forEach(key => {
            const cleanKey = key.toLowerCase().replace(/[^a-z0-9]/g, ''); // Remove spaces/symbols
            newItem[cleanKey] = item[key];
        });
        return newItem;
    }

    window.loadPayments = async function() {
        const tbody = document.getElementById('paymentTableBody');
        tbody.innerHTML = `<tr><td colspan="5" class="text-center p-5 text-muted"><i class="fa-solid fa-circle-notch fa-spin fs-4 mb-2"></i><br>Syncing transactions...</td></tr>`;

        try {
            const res = await fetch(`${WEB_APP_URL}?action=getPayments&t=${new Date().getTime()}`);
            const json = await res.json();
            const rawData = Array.isArray(json) ? json : (json.data || []);

            // DEBUG: Alert once to verify data arrival
            if(rawData.length > 0 && !window.hasAlerted) {
                console.log("First Payment Row:", rawData[0]); // Check console for exact keys
                window.hasAlerted = true; 
            }

            // Normalize every row so we don't worry about spaces/capitalization
            const payments = rawData.map(normalizeData);

            // Sort safely (dates can be tricky)
            payments.sort((a, b) => {
                const dateA = new Date(a.date || 0);
                const dateB = new Date(b.date || 0);
                return dateB - dateA;
            });

            tbody.innerHTML = "";

            if (payments.length === 0) {
                tbody.innerHTML = `<tr><td colspan="5" class="text-center p-5 text-muted">No payments found in the connected Sheet.</td></tr>`;
                return;
            }

            payments.forEach(p => {
                // Now we access using the "clean" keys (lowercase, no spaces)
                
                // 1. DATE
                let dateDisplay = p.date || '-';
                try { 
                    const d = new Date(p.date);
                    if(!isNaN(d)) dateDisplay = d.toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric', hour: '2-digit', minute:'2-digit' });
                } catch(e){}

                // 2. NAME (Looks for 'mpesaname' which matches "M-Pesa Name")
                const name = p.mpesaname || p.tenantname || p.name || 'Unknown';
                
                // 3. REFERENCE (Looks for 'refcode' which matches "Ref Code")
                const ref = p.refcode || p.reference || p.ref || '-';
                
                // 4. STATUS (Looks for 'matchstatus' which matches "Match Status")
                const status = p.matchstatus || 'Received';

                // 5. AMOUNT
                const amount = p.amount || 0;

                tbody.innerHTML += `
                    <tr>
                        <td class="text-muted small fw-bold">${dateDisplay}</td>
                        <td><span class="badge-ref">${ref}</span></td>
                        <td class="fw-bold text-dark">${name}</td>
                        <td><span class="badge-status">${status}</span></td>
                        <td class="text-end fw-bold text-success">${money(amount)}</td>
                    </tr>`;
            });

        } catch(e) {
            console.error(e);
            tbody.innerHTML = `<tr><td colspan="5" class="text-center text-danger p-4">Error loading data. Check console (F12).</td></tr>`;
        }
    }

    if(document.getElementById('logoutBtn')) {
        document.getElementById('logoutBtn').addEventListener('click', () => signOut(auth));
    }
</script>
</body>
</html>

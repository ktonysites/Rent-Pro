<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>RentPro â€” Payments</title>
  
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    :root { --rp-primary: #1d4ed8; --rp-dark: #111827; --rp-light: #f8fafc; --sidebar-width: 220px; }
    body { background: var(--rp-light); font-family: 'Inter', 'Segoe UI', sans-serif; font-size: 0.9rem; color: #334155; }

    /* Sidebar */
    .sidebar { width: var(--sidebar-width); min-height: 100vh; background: var(--rp-dark); color: #fff; position: fixed; top: 0; left: 0; display: flex; flex-direction: column; }
    .sidebar-header { padding: 20px; border-bottom: 1px solid rgba(255,255,255,0.05); }
    .nav-link { color: #94a3b8; padding: 12px 20px; display: flex; align-items: center; gap: 10px; text-decoration: none; transition: 0.2s; }
    .nav-link:hover { background: rgba(255,255,255,0.05); color: #fff; }
    .nav-link.active { background: rgba(59, 130, 246, 0.1); color: #fff; border-right: 3px solid #3b82f6; }
    
    /* Content */
    .content { margin-left: var(--sidebar-width); padding: 25px; }
    
    /* Card Style */
    .card-table { background: #fff; border-radius: 10px; border: 1px solid #e2e8f0; box-shadow: 0 1px 3px rgba(0,0,0,0.05); overflow: hidden; }
    
    /* Table Styling */
    .table thead th { background: #f8fafc; font-weight: 600; text-transform: uppercase; font-size: 0.75rem; color: #64748b; padding: 12px 16px; border-bottom: 1px solid #e2e8f0; }
    .table tbody td { padding: 12px 16px; border-bottom: 1px solid #f1f5f9; vertical-align: middle; }
    
    /* Badges */
    .badge-method { background: #eff6ff; color: #1d4ed8; border: 1px solid #dbeafe; padding: 4px 8px; border-radius: 6px; font-weight: 500; font-size: 0.75rem; }
    .badge-status { background: #f0fdf4; color: #16a34a; border: 1px solid #dcfce7; padding: 4px 8px; border-radius: 20px; font-weight: 600; font-size: 0.7rem; }

    @media (max-width: 768px) { .content { margin-left: 0; } .sidebar { display: none; } }
  </style>
</head>
<body>

  <div class="sidebar">
    <div class="sidebar-header"><h5 class="m-0 fw-bold"><i class="fa-solid fa-layer-group me-2"></i> RentPro</h5></div>
    <nav class="mt-2">
        <a href="dashboard.html" class="nav-link"><i class="fa-solid fa-chart-pie"></i> Dashboard</a>
        <a href="tenants.html" class="nav-link"><i class="fa-solid fa-users"></i> Tenants</a>
        <a href="payments.html" class="nav-link active"><i class="fa-solid fa-money-bill-wave"></i> Payments</a>
        <a href="pay-rent.html" class="nav-link"><i class="fa-solid fa-credit-card"></i> Pay Rent</a>
        <a href="expenses.html" class="nav-link"><i class="fa-solid fa-receipt"></i> Expenses</a>
        <a href="reports.html" class="nav-link"><i class="fa-solid fa-chart-column"></i> Reports</a>
        <div class="mt-auto border-top border-secondary pt-2">
            <a href="#" class="nav-link" id="logoutBtn"><i class="fa-solid fa-right-from-bracket"></i> Logout</a>
        </div>
    </nav>
  </div>

  <main class="content">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <div>
        <h2 class="fw-bold mb-1 text-dark">Payment History</h2>
        <p class="text-muted small m-0">View all transactions and rent records.</p>
      </div>
      <a href="pay-rent.html" class="btn btn-primary shadow-sm btn-sm px-3 py-2">
        <i class="fa-solid fa-plus me-2"></i> Record New Payment
      </a>
    </div>

    <div class="card-table">
      <div class="table-responsive">
        <table class="table table-hover mb-0">
          <thead>
            <tr>
              <th>Date</th>
              <th>Tenant Name</th>
              <th>Method</th>
              <th class="text-end">Amount</th>
              <th class="text-center">Status</th>
            </tr>
          </thead>
          <tbody id="paymentTableBody">
             <tr>
               <td colspan="5" class="text-center p-5 text-muted">
                 <i class="fa-solid fa-circle-notch fa-spin fs-4 mb-2"></i><br>Loading transactions...
               </td>
             </tr>
          </tbody>
        </table>
      </div>
    </div>
  </main>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBwJEOW3jVBHLizWiJjT4a_Tay-2yUCZwk",
        authDomain: "rentpro-saas.firebaseapp.com",
        projectId: "rentpro-saas",
        storageBucket: "rentpro-saas.firebasestorage.app",
        messagingSenderId: "120985965272",
        appId: "1:120985965272:web:c86eae74aa75460b17fdad",
        measurementId: "G-LJRKHT6ZTD"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    let currentUserUID = null;

    const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbzsWx1USYqSBOGLttP8GibfJdSfRLu9bDGSGiuOGj1TuI88gH7nTXJTZqy0Iwd3oMg2_w/exec"; 

    onAuthStateChanged(auth, (user) => {
        if (user) {
            currentUserUID = user.uid;
            loadPayments();
        } else {
            window.location.href = "index.html";
        }
    });

    async function loadPayments() {
        try {
            // Fetch with "getPayments" action
            const res = await fetch(`${WEB_APP_URL}?action=getPayments&t=${new Date().getTime()}`);
            const json = await res.json();
            const allPayments = Array.isArray(json) ? json : (json.data || []);

            // Filter for current user
            const myPayments = allPayments.filter(p => p.OwnerID === currentUserUID);

            // Sort by Date (Newest First)
            myPayments.sort((a, b) => new Date(b.Date) - new Date(a.Date));

            const tbody = document.getElementById('paymentTableBody');
            tbody.innerHTML = "";

            if (myPayments.length === 0) {
                tbody.innerHTML = `<tr><td colspan="5" class="text-center p-5 text-muted">No payments recorded yet.</td></tr>`;
                return;
            }

            // Formatter for Currency
            const fmt = new Intl.NumberFormat('en-KE', { style: 'currency', currency: 'KES', minimumFractionDigits: 0 });

            myPayments.forEach(p => {
                let dateDisplay = p.Date;
                try {
                    const d = new Date(p.Date);
                    dateDisplay = d.toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' });
                } catch(e) {}

                tbody.innerHTML += `
                    <tr>
                        <td class="text-muted small fw-bold">${dateDisplay}</td>
                        <td class="fw-bold text-dark">${p.Name}</td>
                        <td><span class="badge-method">${p.Method || 'Cash'}</span></td>
                        <td class="text-end fw-bold">${fmt.format(p.Amount).replace('KES', '')}</td>
                        <td class="text-center"><span class="badge-status">Paid <i class="fa-solid fa-check ms-1"></i></span></td>
                    </tr>`;
            });

        } catch(e) {
            console.error(e);
            document.getElementById('paymentTableBody').innerHTML = `<tr><td colspan="5" class="text-center text-danger p-4">Error loading data.</td></tr>`;
        }
    }

    document.getElementById('logoutBtn').addEventListener('click', () => signOut(auth));
</script>
</body>
</html>